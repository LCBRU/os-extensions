<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
                      http://www.liquibase.org/xml/ns/dbchangelog-ext 
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <property name="int.type" value="bigint" dbms="mysql" />
  <property name="int.type" value="number(19,0)" dbms="oracle" />

  <property name="text.type" value="varchar" dbms="mysql" />
  <property name="text.type" value="varchar2" dbms="oracle" />

  <property name="clob.type" value="text" dbms="mysql" />
  <property name="clob.type" value="clob" dbms="oracle" />

  <property name="autoIncrement" value="true" dbms="mysql"/>
  <property name="autoIncrement" value="false" dbms="oracle"/>

  <property name="timestamp.type" value="timestamp" dbms="mysql" />
  <property name="timestamp.type" value="timestamp" dbms="oracle" />

  <property name="nullable.ts.type" value="timestamp null" dbms="mysql" />
  <property name="nullable.ts.type" value="timestamp" dbms="oracle" />

  <changeSet author="vpawar" id="REDCap projects">
    <createTable tableName="OS_REDCAP_PROJECTS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="NAME" type="${text.type}(64)">
        <constraints nullable="false"/>
      </column>

      <column name="HOST_URL" type="${text.type}(128)">
        <constraints nullable="false"/>
      </column>

      <column name="PROJECT_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="API_TOKEN" type="${text.type}(255)">
        <constraints nullable="false"/>
      </column>

      <column name="FIELD_TRANSFORMERS" type="${clob.type}">
      </column>

      <column name="SUBJECT_FIELDS" type="${clob.type}">
        <constraints nullable="false"/>
      </column>

      <column name="VISIT_FIELDS" type="${clob.type}">
        <constraints nullable="false"/>
      </column>

      <column name="COLLECTION_PROTOCOL_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="USER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="UPDATE_TIME" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>

      <column name="ACTIVITY_STATUS" type="${text.type}(16)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="REDCap projects sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_REDCAP_PROJECTS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true"/>
  </changeSet>

  <changeSet author="vpawar" id="REDCap project audit logs">
    <createTable tableName="OS_REDCAP_PROJECT_AUDIT_LOGS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="PROJECT_ID" type="${int.type}">
        <constraints nullable="false" />
      </column>

      <column name="OPERATION" type="${text.type}(16)">
        <constraints nullable="false"/>
      </column>

      <column name="START_TIME" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>

      <column name="END_TIME" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>

      <column name="INTERVAL_START_TIME" type="${nullable.ts.type}">
      </column>

      <column name="INTERVAL_END_TIME" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>
     
      <column name="USER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="RECS_COUNT" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="STATUS" type="${text.type}(16)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="REDCap project audit logs sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_REDCAP_PROJ_AUDIT_LOGS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vpawar" id="REDCap records mapping">
    <createTable tableName="OS_REDCAP_RECORDS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="RECORD_ID" type="${text.type}(255)">
        <constraints nullable="false" />
      </column>

      <column name="PROJECT_ID" type="${text.type}(32)">
        <constraints nullable="false" />
      </column>
     
      <column name="CPR_ID" type="${int.type}">
        <constraints nullable="false" />
      </column>

      <column name="VISIT_ID" type="${int.type}">
        <constraints nullable="false" />
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="REDCap records mapping sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_REDCAP_RECORDS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vpawar" id="Add column to track log file containing failed events">
    <addColumn tableName="OS_REDCAP_PROJECT_AUDIT_LOGS">
      <column name="FAILED_EVENTS_LOG" type="${text.type}(64)">
      </column>
    </addColumn>
  </changeSet>
</databaseChangeLog>
